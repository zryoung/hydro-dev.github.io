<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>使用 JavaScript 编写插件 | Hydro</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/hydro.png">
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-CX4XJ0H0TE"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-CX4XJ0H0TE');</script>
    <link rel="alternate" type="application/atom+xml" href="https://hydro.js.org/atom.xml" title="Hydro Atom Feed">
    <link rel="alternate" type="application/json" href="https://hydro.js.org/feed.json" title="Hydro JSON Feed">
    <link rel="alternate" type="application/rss+xml" href="https://hydro.js.org/rss.xml" title="Hydro RSS Feed">
    <link rel="manifest" href="/manifest.webmanifest" crossorigin="use-credentials">
    <meta name="description" content="">
    <meta property="og:url" content="/dev/javascript.html">
    <meta property="og:site_name" content="Hydro">
    <meta property="og:title" content="使用 JavaScript 编写插件">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="en-US">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image:alt" content="Hydro">
    <meta name="theme-color" content="#ffeded">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="preload" href="/assets/css/0.styles.3be042f4.css" as="style"><link rel="preload" href="/assets/js/app.9be10bc1.js" as="script"><link rel="preload" href="/assets/js/layout-Layout.47b6f70b.js" as="script"><link rel="preload" href="/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.3ae24e86.js" as="script"><link rel="preload" href="/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound~layout-Slide.115a3591.js" as="script"><link rel="preload" href="/assets/js/vendors~layout-Blog~layout-Layout.495a8045.js" as="script"><link rel="preload" href="/assets/js/page-使用JavaScript编写插件.6a440a36.js" as="script"><link rel="prefetch" href="/assets/js/4.f0cd068c.js"><link rel="prefetch" href="/assets/js/45.3dfbf0be.js"><link rel="prefetch" href="/assets/js/46.7eeceacc.js"><link rel="prefetch" href="/assets/js/47.a6f025be.js"><link rel="prefetch" href="/assets/js/48.79184ca8.js"><link rel="prefetch" href="/assets/js/49.7355c58d.js"><link rel="prefetch" href="/assets/js/layout-Blog.44f770ea.js"><link rel="prefetch" href="/assets/js/layout-NotFound.3950b202.js"><link rel="prefetch" href="/assets/js/layout-Slide.40a2a74d.js"><link rel="prefetch" href="/assets/js/page-Home.9dc85b4d.js"><link rel="prefetch" href="/assets/js/page-HydroCli.f3996262.js"><link rel="prefetch" href="/assets/js/page-SMTP.b88600f4.js"><link rel="prefetch" href="/assets/js/page-Sonic.b6cb9598.js"><link rel="prefetch" href="/assets/js/page-Vjudge.3c243bce.js"><link rel="prefetch" href="/assets/js/page-fps-importer.3ef398a3.js"><link rel="prefetch" href="/assets/js/page-hydrojudge.ce7df22d.js"><link rel="prefetch" href="/assets/js/page-migrate-vijos.cea3093c.js"><link rel="prefetch" href="/assets/js/page-recaptcha.15ea648c.js"><link rel="prefetch" href="/assets/js/page-介绍.68b009e6.js"><link rel="prefetch" href="/assets/js/page-使用TypeScript编写插件.029607e9.js"><link rel="prefetch" href="/assets/js/page-使用内容分发网络.2264d7dd.js"><link rel="prefetch" href="/assets/js/page-初始化.22dff0f8.js"><link rel="prefetch" href="/assets/js/page-前端修改.abd5961a.js"><link rel="prefetch" href="/assets/js/page-反向代理SSL配置.9738de15.js"><link rel="prefetch" href="/assets/js/page-域.8d5fc432.js"><link rel="prefetch" href="/assets/js/page-多域间联合排名.b0d81d76.js"><link rel="prefetch" href="/assets/js/page-存储.ee807e6d.js"><link rel="prefetch" href="/assets/js/page-导入用户.f3e74018.js"><link rel="prefetch" href="/assets/js/page-常见问题杂项.f6c6a769.js"><link rel="prefetch" href="/assets/js/page-开发环境部署.f936fe06.js"><link rel="prefetch" href="/assets/js/page-插件.9443e848.js"><link rel="prefetch" href="/assets/js/page-数据库备份和恢复.6389fb43.js"><link rel="prefetch" href="/assets/js/page-权限节点.4fee2c97.js"><link rel="prefetch" href="/assets/js/page-测试数据格式.e40cd52e.js"><link rel="prefetch" href="/assets/js/page-用户文档.6879a6cb.js"><link rel="prefetch" href="/assets/js/page-端口映射.82cadeea.js"><link rel="prefetch" href="/assets/js/page-维护.3f1e747e.js"><link rel="prefetch" href="/assets/js/page-跨域引用题目.f59604ec.js"><link rel="prefetch" href="/assets/js/page-部署Hydro.0ce90e43.js"><link rel="prefetch" href="/assets/js/page-题目.42d902fe.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.9387c930.js"><link rel="prefetch" href="/assets/js/vendors~photo-swipe.687e7cd0.js"><link rel="prefetch" href="/assets/js/vendors~reveal.97920e7b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.3be042f4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container has-navbar has-sidebar has-anchor"><header class="navbar"><button class="sidebar-button"><span class="icon"></span></button> <a href="/" class="home-link router-link-active"><img src="/favicon.ico" alt="Hydro" class="logo"> <!----> <span class="site-name can-hide">Hydro</span></a> <div class="links"><button class="color-button"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="skin-icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4
        38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32
        51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0
        102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2
        6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4
        0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2
        9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224
        419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4
        470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0
        22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6
        12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128
        505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2
        16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8
        86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4
        80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6
        6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg> <div class="color-picker-menu" style="display:none;"><div class="theme-options"><ul class="themecolor-select"><label for="themecolor-select">Theme Color:</label> <li><a href="#" class="default-theme"></a></li> </ul> <div class="darkmode-toggle"><label for="darkmode-toggle" class="desc">Theme Mode:</label> <div class="darkmode-switch"><div class="item day"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon light-icon"><path d="M512 256a42.667 42.667 0 0 0 42.667-42.667V128a42.667 42.667 0 0 0-85.334 0v85.333A42.667 42.667 0 0 0 512 256zm384 213.333h-85.333a42.667 42.667 0 0 0 0 85.334H896a42.667 42.667 0 0 0 0-85.334zM256 512a42.667 42.667 0 0 0-42.667-42.667H128a42.667 42.667 0 0 0 0 85.334h85.333A42.667 42.667 0 0 0 256 512zm9.387-298.667a42.667 42.667 0 0 0-59.307 62.72l61.44 59.307a42.667 42.667 0 0 0 31.147 11.947 42.667 42.667 0 0 0 30.72-13.227 42.667 42.667 0 0 0 0-60.16zm459.946 133.974a42.667 42.667 0 0 0 29.44-11.947l61.44-59.307a42.667 42.667 0 0 0-57.6-62.72l-61.44 60.587a42.667 42.667 0 0 0 0 60.16 42.667 42.667 0 0 0 28.16 13.227zM512 768a42.667 42.667 0 0 0-42.667 42.667V896a42.667 42.667 0 0 0 85.334 0v-85.333A42.667 42.667 0 0 0 512 768zm244.48-79.36a42.667 42.667 0 0 0-59.307 61.44l61.44 60.587a42.667 42.667 0 0 0 29.44 11.946 42.667 42.667 0 0 0 30.72-12.8 42.667 42.667 0 0 0 0-60.586zm-488.96 0-61.44 59.307a42.667 42.667 0 0 0 0 60.586 42.667 42.667 0 0 0 30.72 12.8 42.667 42.667 0 0 0 28.587-10.666l61.44-59.307a42.667 42.667 0 0 0-59.307-61.44zM512 341.333A170.667 170.667 0 1 0 682.667 512 170.667 170.667 0 0 0 512 341.333z" fill="currentColor"></path></svg></div> <div class="item auto active"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon auto-icon"><path d="M460.864 539.072H564.8L510.592 376l-49.728 163.072zM872 362.368V149.504H659.648L510.528 0l-149.12 149.504H149.12v212.928L0 511.872l149.12 149.504v212.928h212.352l149.12 149.504 149.12-149.504h212.352V661.376l149.12-149.504L872 362.368zM614.464 693.12l-31.616-90.624H438.272l-31.616 90.624h-85.888l144.576-407.68h90.368l144.576 407.68h-85.824zm0 0" fill="currentColor"></path></svg></div> <div class="item night"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon dark-icon"><path d="M935.539 630.402c-11.43-11.432-28.674-14.739-43.531-8.354-46.734 20.103-96.363 30.297-147.508 30.297-99.59 0-193.221-38.784-263.64-109.203-108.637-108.637-139.61-270.022-78.908-411.148a39.497 39.497 0 0 0-51.886-51.887c-52.637 22.64-100.017 54.81-140.826 95.616-85.346 85.346-132.346 198.821-132.346 319.52 0 120.7 47.001 234.172 132.347 319.519S408.063 947.11 528.76 947.11c120.7 0 234.172-47.003 319.52-132.351 40.809-40.81 72.978-88.19 95.616-140.826a39.497 39.497 0 0 0-8.356-43.532z" fill="currentColor"></path></svg></div></div> <!----></div></div></div></button> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/" class="nav-link"><!---->
  文档
</a></div><div class="nav-item"><a href="/dev/" class="nav-link router-link-active active"><!---->
  开发
</a></div><div class="nav-item"><a href="/plugins/" class="nav-link"><!---->
  插件
</a></div></nav> <!----> <a rel="noopener noreferrer" href="https://github.com/hydro-dev/Hydro" target="_blank" class="repo-link can-hide">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <nav class="sidebar-nav-links"><div class="nav-item"><a href="/docs/" class="nav-link"><!---->
  文档
</a></div><div class="nav-item"><a href="/dev/" class="nav-link router-link-active active"><!---->
  开发
</a></div><div class="nav-item"><a href="/plugins/" class="nav-link"><!---->
  插件
</a></div> <a rel="noopener noreferrer" href="https://github.com/hydro-dev/Hydro" target="_blank" class="repo-link">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><!----> <span class="title">开发</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/dev/" aria-current="page" class="sidebar-link">开发环境部署</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dev/#安装依赖" class="sidebar-link">安装依赖</a></li><li class="sidebar-sub-header"><a href="/dev/#安装-hydro" class="sidebar-link">安装 Hydro</a></li><li class="sidebar-sub-header"><a href="/dev/#启动-hydro" class="sidebar-link">启动 Hydro</a></li><li class="sidebar-sub-header"><a href="/dev/#更新" class="sidebar-link">更新</a></li></ul></li><li><a href="/dev/PERM_PRIV/" class="sidebar-link">权限节点</a></li><li><a href="/dev/javascript/" aria-current="page" class="active sidebar-link">使用 JavaScript 编写插件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dev/javascript/#step1-初始化项目" class="sidebar-link">Step1 初始化项目</a></li><li class="sidebar-sub-header"><a href="/dev/javascript/#step2-准备编写组件" class="sidebar-link">Step2 准备编写组件</a></li><li class="sidebar-sub-header"><a href="/dev/javascript/#step3-model-js" class="sidebar-link">Step3 model.js</a></li><li class="sidebar-sub-header"><a href="/dev/javascript/#step4-handler-js" class="sidebar-link">Step4 handler.js</a></li><li class="sidebar-sub-header"><a href="/dev/javascript/#step5-template" class="sidebar-link">Step5 template</a></li><li class="sidebar-sub-header"><a href="/dev/javascript/#step6-locale" class="sidebar-link">Step6 locale</a></li></ul></li><li><a href="/dev/typescript/" class="sidebar-link">使用 TypeScript 编写插件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dev/typescript/#step1-初始化项目" class="sidebar-link">Step1 初始化项目</a></li><li class="sidebar-sub-header"><a href="/dev/typescript/#step2-准备编写组件" class="sidebar-link">Step2 准备编写组件</a></li><li class="sidebar-sub-header"><a href="/dev/typescript/#step3-model-js" class="sidebar-link">Step3 model.js</a></li><li class="sidebar-sub-header"><a href="/dev/typescript/#step4-handler-js" class="sidebar-link">Step4 handler.js</a></li><li class="sidebar-sub-header"><a href="/dev/typescript/#step5-template" class="sidebar-link">Step5 template</a></li><li class="sidebar-sub-header"><a href="/dev/typescript/#step6-locale" class="sidebar-link">Step6 locale</a></li></ul></li><li><a href="/dev/frontend-modify/" class="sidebar-link">前端修改</a></li></ul></section></li></ul> </aside> <main class="page"><nav class="breadcrumb"><ol vocab="https://schema.org/" typeof="BreadcrumbList"><li property="itemListElement" typeof="ListItem"><a href="/dev/" property="item" typeof="WebPage" class="router-link-active"><!----> <span property="name">开发环境部署</span></a> <meta property="position" content="1"></li><li property="itemListElement" typeof="ListItem" class="is-active"><a href="/dev/javascript/" aria-current="page" property="item" typeof="WebPage" class="router-link-exact-active router-link-active"><!----> <span property="name">使用 JavaScript 编写插件</span></a> <meta property="position" content="2"></li></ol></nav>  <div vocab="https://schema.org/" typeof="Article" class="page-title"><h1><!----> <span property="headline">使用 JavaScript 编写插件</span></h1> <!----> <!----> <hr></div> <div class="anchor-place-holder"><aside id="anchor"><div class="anchor-wrapper"><ul class="anchor-list"><li class="anchor"><a href="/dev/javascript/#step1-初始化项目" class="anchor-link heading2"><div>Step1 初始化项目</div></a></li><li class="anchor"><a href="/dev/javascript/#step2-准备编写组件" class="anchor-link heading2"><div>Step2 准备编写组件</div></a></li><li class="anchor"><a href="/dev/javascript/#step3-model-js" class="anchor-link heading2"><div>Step3 model.js</div></a></li><li class="anchor"><a href="/dev/javascript/#step4-handler-js" class="anchor-link heading2"><div>Step4 handler.js</div></a></li><li class="anchor"><a href="/dev/javascript/#step5-template" class="anchor-link heading2"><div>Step5 template</div></a></li><li class="anchor"><a href="/dev/javascript/#step6-locale" class="anchor-link heading2"><div>Step6 locale</div></a></li></ul></div></aside></div> <div class="theme-default-content content__default"><h1 id="使用-javascript-编写插件"><a href="#使用-javascript-编写插件" class="header-anchor">#</a> 使用 JavaScript 编写插件</h1> <p>前置条件：NodeJS&gt;10.4<br>
此教程将以编写剪贴板插件为例进行说明。</p> <p><strong>Hydro v2 更加推荐您使用 TypeScript。</strong></p> <h2 id="step1-初始化项目"><a href="#step1-初始化项目" class="header-anchor">#</a> Step1 初始化项目</h2> <p>使用 <code>hydrooj addon create</code> 快速在 <code>/root/addon</code> 下初始化一个插件或是在一个空文件夹中运行 <code>yarn init</code> 并按照提示填写相关信息。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment"># 使用 yarn init 的样例</span>
/workspace/hydro-plugin $ <span class="token function">yarn</span> init
<span class="token function">yarn</span> init v1.22.4
question name <span class="token punctuation">(</span>hydro-plugin<span class="token punctuation">)</span>: @hydrooj/pastebin
question version <span class="token punctuation">(</span><span class="token number">1.0</span>.0<span class="token punctuation">)</span>: <span class="token number">0.0</span>.1
question description: HydroOJ的剪贴板组件
question entry point <span class="token punctuation">(</span>index.js<span class="token punctuation">)</span>: package.json
question repository url: https://github.com/hydro-dev/pastebin.git
question author: undefined <span class="token operator">&lt;</span>i@undefined.moe<span class="token operator">&gt;</span>
question license <span class="token punctuation">(</span>MIT<span class="token punctuation">)</span>: MIT
question private:
success Saved package.json
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="step2-准备编写组件"><a href="#step2-准备编写组件" class="header-anchor">#</a> Step2 准备编写组件</h2> <p>分析：剪贴板组件需要以下功能：</p> <ul><li>与数据库交互来存储/检索相应文档。</li> <li>提供 /paste/create 路由以创建新文档。</li> <li>提供 /paste/show/:ID 来查看已创建的文档。</li> <li>根据用户ID进行鉴权，允许将文档设置为私密以防止他人查看。</li></ul> <p>Hydro的推荐架构如下：</p> <ul><li>handler.js: 用于处理路由</li> <li>model.js: 数据库模型</li> <li>lib.js: 不依赖于数据库等的库（如md5函数）</li> <li>script.js: 可能会被用户多次使用到的脚本（如重新计算rp）</li> <li>locale/: 翻译文件</li> <li>template/: 页面模板</li> <li>setting.yaml: 模块所用到的设置，格式在下方说明</li></ul> <p>但注意上述结构并非全部必要，可以只创建插件需要使用的结构。</p> <h2 id="step3-model-js"><a href="#step3-model-js" class="header-anchor">#</a> Step3 model.js</h2> <p>提示：由于模块中不便于使用 require() 引入 Hydro 的文件，可以从 global.Hydro 中取出需要的模块。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> db <span class="token punctuation">}</span> <span class="token operator">=</span> global<span class="token punctuation">.</span>Hydro<span class="token punctuation">.</span>service<span class="token punctuation">;</span> <span class="token comment">// 数据库连接</span>
<span class="token keyword">const</span> coll <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'paste'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 添加一个文档
 * @param {number} userId
 * @param {string} content
 * @param {boolean} isPrivate
 * @return {Promise&lt;string&gt;}
 */</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">userId<span class="token punctuation">,</span> content<span class="token punctuation">,</span> isPrivate</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> pasteId <span class="token operator">=</span> String<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Hydro提供了此方法，创建一个长度为16的随机字符串</span>
    <span class="token comment">// 使用 mongodb 为数据库驱动，相关操作参照其文档</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> coll<span class="token punctuation">.</span><span class="token function">insertOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        _id<span class="token operator">:</span> pasteId<span class="token punctuation">,</span>
        owner<span class="token operator">:</span> userId<span class="token punctuation">,</span>
        content<span class="token punctuation">,</span>
        isPrivate<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">.</span>insertedId<span class="token punctuation">;</span> <span class="token comment">// 返回插入的文档ID</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 查询一个文档
 * @param {string} pasteId
 * @return {Promise&lt;any&gt;}
 */</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token parameter">pasteId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> coll<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> _id<span class="token operator">:</span> pasteId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 暴露这些接口</span>
global<span class="token punctuation">.</span>Hydro<span class="token punctuation">.</span>model<span class="token punctuation">.</span>pastebin <span class="token operator">=</span> <span class="token punctuation">{</span> add<span class="token punctuation">,</span> <span class="token keyword">get</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h2 id="step4-handler-js"><a href="#step4-handler-js" class="header-anchor">#</a> Step4 handler.js</h2> <p>在路由中定义所有的函数应均为异步函数，支持的函数有：prepare, get, post, post[Operation], cleanup
具体流程如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>先执行 prepare(args) （如果存在）
args 为传入的参数集合（包括 QueryString, Body, Path）中的全部参数，
再执行 prepare(args) （如果存在）
检查请求类型：

为 GET ？
  -&gt; 执行 get(args)
为 POST ?
  -&gt; 执行 post(args)
  -&gt; 含有 operation 字段？
       -&gt; 执行 post[Operation]

执行 cleanup()
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>如果在 this.response.template 指定模板则渲染，否则直接返回 this.response.body 中的内容。</p> <ul><li>在表单提交时的 operation 字段使用下划线，函数名使用驼峰命名。</li></ul> <p>如 <code>&lt;input type=&quot;hidden&quot; name=&quot;operation&quot; value=&quot;confirm_delete&quot;&gt;</code> 对应 <code>postConfirmDelete</code> 函数。</p> <p>应当提供 <code>apply</code> 函数，并与定义的 Handler 一同挂载到 <code>global.Hydro.handler[模块名]</code> 位置。
<code>apply</code> 函数将在初始化阶段被调用。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Route<span class="token punctuation">,</span> Handler <span class="token punctuation">}</span> <span class="token operator">=</span> global<span class="token punctuation">.</span>Hydro<span class="token punctuation">.</span>service<span class="token punctuation">.</span>server<span class="token punctuation">;</span> <span class="token comment">// 注册路由所用工具</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">PRIV</span> <span class="token punctuation">}</span> <span class="token operator">=</span> global<span class="token punctuation">.</span>Hydro<span class="token punctuation">.</span>model<span class="token punctuation">.</span>builtin<span class="token punctuation">;</span> <span class="token comment">// 内置 Privilege 权限节点</span>
<span class="token keyword">const</span> pastebin <span class="token operator">=</span> global<span class="token punctuation">.</span>Hydro<span class="token punctuation">.</span>model<span class="token punctuation">.</span>pastebin<span class="token punctuation">;</span> <span class="token comment">// 刚刚编写的pastebin模型</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> checkContent <span class="token punctuation">}</span> <span class="token operator">=</span> global<span class="token punctuation">.</span>Hydro<span class="token punctuation">.</span>lib<span class="token punctuation">.</span>validator<span class="token punctuation">;</span> <span class="token comment">// 用于检查用户输入是否合法</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> NotFoundError <span class="token punctuation">}</span> <span class="token operator">=</span> global<span class="token punctuation">.</span>Hydro<span class="token punctuation">.</span>error<span class="token punctuation">;</span>

<span class="token comment">// 创建新路由</span>
<span class="token keyword">class</span> <span class="token class-name">PasteCreateHandler</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{</span>
    <span class="token comment">// Get请求时触发该函数</span>
    <span class="token keyword">async</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 检查用户是否登录，此处为多余（因为底部注册路由时已声明所需权限）</span>
        <span class="token comment">// 此方法适用于权限的动态检查</span>
        <span class="token comment">// this.checkPriv(PRIV.PRIV_USER_PROFILE);</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>response<span class="token punctuation">.</span>template <span class="token operator">=</span> <span class="token string">'paste_create.html'</span><span class="token punctuation">;</span> <span class="token comment">// 返回此页面</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">async</span> <span class="token function">post</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> content<span class="token punctuation">,</span> <span class="token keyword">private</span> <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 从用户提交的表单中取出content和private字段</span>
        <span class="token function">checkContent</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 检查输入</span>
        <span class="token comment">// 在HTML表单提交的多选框中，选中值为 'on'，未选中则为空，需要进行转换</span>
        <span class="token keyword">await</span> pastebin<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>user<span class="token punctuation">.</span>_id<span class="token punctuation">,</span> content<span class="token punctuation">,</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token keyword">private</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将用户重定向到创建完成的url</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>response<span class="token punctuation">.</span>redirect <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token string">'paste_show'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> pasteid <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">PasteShowHandler</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> doc <span class="token operator">=</span> <span class="token keyword">await</span> pastebin<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>doc<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotFoundError</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>doc<span class="token punctuation">.</span>isPrivate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>user<span class="token punctuation">.</span>_id <span class="token operator">!==</span> doc<span class="token punctuation">.</span>owner<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PermissionError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>response<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span> doc <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>response<span class="token punctuation">.</span>template <span class="token operator">=</span> <span class="token string">'paste_show.html'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">async</span> <span class="token function">postDelete</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> id <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 当提交表单并存在 operation 值为 delete 时执行。</span>
        <span class="token comment">// 本例中未实现删除功能，仅作为说明。</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Hydro会在服务初始化完成后调用该函数。</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 注册一个名为 paste_create 的路由，匹配 '/paste/create'，</span>
    <span class="token comment">// 使用PasteCreateHandler处理，访问改路由需要PRIV.PRIV_USER_PROFILE权限</span>
    <span class="token comment">// 提示：路由匹配基于 path-to-regexp</span>
    <span class="token function">Route</span><span class="token punctuation">(</span><span class="token string">'paste_create'</span><span class="token punctuation">,</span> <span class="token string">'/paste/create'</span><span class="token punctuation">,</span> PasteCreateHandler<span class="token punctuation">,</span> <span class="token constant">PRIV</span><span class="token punctuation">.</span><span class="token constant">PRIV_USER_PROFILE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Route</span><span class="token punctuation">(</span><span class="token string">'paste_show'</span><span class="token punctuation">,</span> <span class="token string">'/paste/show/:id'</span><span class="token punctuation">,</span> PasteShowHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

global<span class="token punctuation">.</span>Hydro<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>pastebin <span class="token operator">=</span> apply<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><h2 id="step5-template"><a href="#step5-template" class="header-anchor">#</a> Step5 template</h2> <p>模板采用 nunjucks 语法。放置于 templates/ 文件夹下。<br>
会在请求结束时根据 <code>response.template</code> 的值选择模板，并使用 <code>response.body</code> 的值进行渲染，存入 <code>response.body</code> 中。<br>
若 <code>response.template</code> 为空或 <code>request.headers['accept'] == 'application/json'</code>，则跳过渲染步骤。</p> <h2 id="step6-locale"><a href="#step6-locale" class="header-anchor">#</a> Step6 locale</h2> <p>用于提供多国翻译。格式与 Hydro 的 locale 文件夹格式相同。</p></div> <footer class="page-meta"><div class="edit-link"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon edit-icon"><path d="M117.953 696.992 64.306 959.696l265.931-49.336 450.204-452.505-212.284-213.376-450.204 452.513zm496.384-296.326L219.039 797.993l-46.108-46.34L568.233 354.33l46.104 46.335zm345.357-122.99-114.45 115.04-212.288-213.377 114.45-115.035 212.288 213.371zm0 0" fill="currentColor"></path></svg> <a href="https://github.com/hydro-dev/hydro-dev.github.io/edit/docs/dev/javascript.md" target="_blank" rel="noopener noreferrer">Edit this page</a></div> <div class="meta-item update-time"><span class="label">Last update:</span> <span class="info">August 13, 2021 07:34</span></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/dev/PERM_PRIV/" class="prev"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon prev-icon"><path d="M906.783 588.79c-.02 8.499-6.882 15.36-15.38 15.37l-443.7-.01 75.704 191.682c2.52 6.42.482 13.763-5.038 17.91-5.52 4.168-13.138 4.147-18.616-.092L123.228 524.175a15.362 15.362 0 0 1-6-12.165c0-4.782 2.222-9.277 6-12.185L499.753 210.35a15.388 15.388 0 0 1 9.38-3.195c3.236 0 6.502 1.034 9.236 3.103 5.52 4.147 7.578 11.49 5.038 17.91L447.683 419.84l443.72-.01c8.498.01 15.36 6.881 15.36 15.36l.02 153.6z" fill="currentColor"></path></svg>
        权限节点
      </a></span> <span class="next"><a href="/dev/typescript/">
        使用 TypeScript 编写插件
        <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon next-icon"><path d="M906.772 512c0 4.772-2.211 9.267-5.99 12.175L524.257 813.66a15.37 15.37 0 0 1-18.616.092 15.368 15.368 0 0 1-5.038-17.91l75.714-191.672h-443.73c-8.488 0-15.36-6.881-15.36-15.36v-153.6c0-8.489 6.872-15.36 15.36-15.36h443.73l-75.714-191.682a15.358 15.358 0 0 1 5.048-17.91c5.51-4.158 13.128-4.137 18.606.092l376.525 289.485a15.323 15.323 0 0 1 5.99 12.165z" fill="currentColor"></path></svg></a></span></p></div> <!----> </main> <!----></div><div class="global-ui"><!----><!----><div id="pwa-install"><!----> <div id="install-modal-wrapper" style="display:none;"><div class="background"></div> <div class="install-modal"><div class="header"><button aria-label="Close" class="close-button"><svg width="23" height="22" xmlns="http://www.w3.org/2000/svg" class="icon close-icon"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.12.358a1.224 1.224 0 011.729 0l8.92 8.914L20.686.358a1.224 1.224 0 011.73 1.728L13.497 11l8.92 8.913a1.222 1.222 0 11-1.73 1.729l-8.919-8.913-8.92 8.913a1.224 1.224 0 01-1.729-1.729L10.04 11l-8.92-8.914a1.222 1.222 0 010-1.728z" fill="currentColor"></path></svg></button> <div class="logo"><!----> <div class="title"><h1></h1> <p class="desc">This app can be installed on your PC or mobile device.  This will allow this web app to look and behave like any other installed app.  You will find it in your app lists and be able to pin it to your home screen, start menus or task bars.  This installed web app will also be able to safely interact with other apps and your operating system. </p></div></div></div> <div class="content"><div class="highlight"><!----> <!----></div> <div class="description"><h3>Description</h3> <p></p></div></div> <div class="button-wrapper"><button class="install-button">
        Install <span></span></button> <button class="cancel-button">
        Cancel
      </button></div></div></div></div><div tabindex="-1" role="dialog" aria-hidden="true" class="pswp"><div class="pswp__bg"></div> <div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div> <div class="pswp__item"></div> <div class="pswp__item"></div></div> <div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div> <button title="Close (Esc)" class="pswp__button pswp__button--close"></button> <button title="Share" class="pswp__button pswp__button--share"></button> <button title="Toggle fullscreen" class="pswp__button pswp__button--fs"></button> <button title="Zoom in/out" class="pswp__button pswp__button--zoom"></button> <div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div> <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div> <button title="Previous (arrow left)" class="pswp__button pswp__button--arrow--left"></button> <button title="Next (arrow right)" class="pswp__button pswp__button--arrow--right"></button> <div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div><!----></div></div>
    <script src="/assets/js/app.9be10bc1.js" defer></script><script src="/assets/js/layout-Layout.47b6f70b.js" defer></script><script src="/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.3ae24e86.js" defer></script><script src="/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound~layout-Slide.115a3591.js" defer></script><script src="/assets/js/vendors~layout-Blog~layout-Layout.495a8045.js" defer></script><script src="/assets/js/page-使用JavaScript编写插件.6a440a36.js" defer></script>
  </body>
</html>
